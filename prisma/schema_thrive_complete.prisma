// SAT Connect - T.H.R.I.V.E. Engine Complete Schema
// 6 Entidades Relacionales + 38 Columnas Mapeadas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ============================================================================
// ENTIDAD 1: Tours (Core Data - 9 campos)
// ============================================================================
model Tour {
  id                        Int       @id @default(autoincrement())
  bokun_id                  Int?      @unique                  // Col A - B贸kun ID / SKU
  product_name              String                              // Col B - Activity Name
  supplier                  String                              // Col C - Supplier
  location                  String                              // Col D - Location
  bokun_marketplace_status  String?                             // Col E - B贸kun Marketplace Status
  bokun_status              String?                             // Col F - B贸kun Status
  is_active                 Boolean   @default(true)            // Col G - Active Product
  is_audited                Boolean   @default(false)           // Col H - Audited
  last_update               DateTime  @default(now()) @updatedAt // Col T - Last Update

  // Relaciones 1:1 con entidades especializadas
  pricing                   TourPricing?
  logistics                 TourLogistics?
  assets                    TourAssets?
  distribution              TourDistribution?
  audit                     TourAudit?

  createdAt                 DateTime  @default(now())

  @@map("tours")
  @@index([supplier])
  @@index([location])
  @@index([is_active])
}

// ============================================================================
// ENTIDAD 2: TourPricing (Revenue Optimization - 14 campos)
// ============================================================================
model TourPricing {
  id                        Int       @id @default(autoincrement())
  tour_id                   Int       @unique
  tour                      Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // SHARED RATES
  net_rate_adult            Decimal   @db.Decimal(10, 2)        // Col I - Shared Adult Net
  shared_factor             Decimal   @default(1.5) @db.Decimal(4, 2) // Col J - Shared Factor (1.5-1.99)
  // CALCULATED: suggested_pvp_adult = net_rate_adult * shared_factor (Col K)
  
  net_rate_child            Decimal?  @db.Decimal(10, 2)        // Col L - Shared Child Net
  // CALCULATED: suggested_pvp_child = net_rate_child * shared_factor (Col M)
  
  infant_age_threshold      Int?                                // Col N - Free Infant Age
  shared_min_pax            Int?                                // Col O - Shared Min Pax

  // PRIVATE RATES
  net_rate_private          Decimal?  @db.Decimal(10, 2)        // Col Q - Private Net
  private_factor            Decimal   @default(1.5) @db.Decimal(4, 2) // Col R - Private Factor
  private_min_pax           Int?                                // Col P - Private Min Pax
  private_min_pax_net_rate  Decimal?  @db.Decimal(10, 2)        // Private Min Pax Net Rate (base calculation)
  // CALCULATED: suggested_pvp_private = private_min_pax_net_rate * private_factor (Col S)
  // CALCULATED: per_pax_cost = private_min_pax_net_rate / private_min_pax (Col T)

  extra_fees                String?                             // Col AB - Extra Fees

  @@map("tour_pricing")
}

// ============================================================================
// ENTIDAD 3: TourLogistics (Operations - 5 campos)
// ============================================================================
model TourLogistics {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  duration              String?                                 // Col V - Duration
  days_of_operation     String?                                 // Col W - Days of Operation
  cxl_policy            String?                                 // Col X - CXL Policy
  meeting_point_info    String?   @db.Text                      // Col AA - Meeting Point / Pick Up
  pickup_info           String?   @db.Text                      // Pickup Information (complementary)

  @@map("tour_logistics")
}

// ============================================================================
// ENTIDAD 4: TourAssets (Content - 5 campos)
// ============================================================================
model TourAssets {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  pictures_url          String?                                 // Col U - Pictures Link
  landing_page_url      String?                                 // Col Y - Landing Page
  storytelling_url      String?                                 // Col Z - Storytelling Link
  notes                 String?   @db.Text                      // Col AL - Audit Notes
  capture_status        Boolean   @default(false)               // Capture Status (content captured)

  @@map("tour_assets")
}

// ============================================================================
// ENTIDAD 5: TourDistribution (OTA Markups - 15 campos)
// ============================================================================
model TourDistribution {
  id                            Int       @id @default(autoincrement())
  tour_id                       Int       @unique
  tour                          Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // MARKUPS
  website_markup                Decimal?  @db.Decimal(5, 2)     // Website Markup %
  marketplace_bokun_markup      Decimal?  @db.Decimal(5, 2)     // Marketplace B贸kun Markup %
  marketplace_b2b_markup        Decimal?  @db.Decimal(5, 2)     // Marketplace B2B Markup %

  // OTA CHANNELS - Project Expedition
  project_expedition_id         Int?                            // Col AC - Project Expedition ID
  project_expedition_status     String?                         // Col AD - Project Expedition Status

  // OTA CHANNELS - Expedia
  expedia_id                    Int?                            // Col AE - Expedia ID
  expedia_status                String?                         // Col AF - Expedia Status

  // OTA CHANNELS - Viator
  viator_id                     String?                         // Col AG - Viator ID
  viator_commission_percent     Decimal?  @db.Decimal(5, 2)     // Viator Commission %
  viator_status                 String?                         // Col AH - Viator Status

  // OTA CHANNELS - Klook
  klook_id                      Int?                            // Col AI - Klook ID
  klook_status                  String?                         // Col AJ - Klook Status

  // OTA CHANNELS - Additional Channels
  tur_com_status                String?                         // Tur.com Status
  tourist_com_status            String?                         // Tourist.com Status
  headout_status                String?                         // Headout Status
  tourradar_status              String?                         // TourRadar Status

  @@map("tour_distribution")
}

// ============================================================================
// ENTIDAD 6: TourAudit (T.H.R.I.V.E. Logic - 3 campos)
// ============================================================================
model TourAudit {
  id                                Int       @id @default(autoincrement())
  tour_id                           Int       @unique
  tour                              Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // CALCULATED: HEALTHY | INCOMPLETE | AUDIT_REQUIRED
  product_health_score              String    @default("INCOMPLETE")
  
  // CALCULATED: 0-100 based on active OTA channels
  otas_distribution_score           Int       @default(0)
  
  // CALCULATED: Based on health + price parity
  is_suitable_for_global_distribution Boolean @default(false)

  @@map("tour_audit")
}

// ============================================================================
// SUPPORTING MODELS (Existing - kept for compatibility)
// ============================================================================

model ChannelLog {
  id        String   @id @default(cuid())
  tourId    Int
  
  channel   String   // "expedia", "viator", "gyg", "civitatis"
  status    String   // "Active", "Inactive"
  
  updatedAt DateTime @updatedAt
  
  @@unique([tourId, channel])
  @@index([channel, status])
  @@map("channel_logs")
}

model Booking {
  id            String   @id @default(cuid())
  tourId        Int
  
  customerName  String
  customerEmail String?
  bookingDate   DateTime
  tourDate      DateTime
  
  adults        Int      @default(1)
  children      Int      @default(0)
  infants       Int      @default(0)
  
  totalPrice    Decimal  @db.Decimal(10, 2)
  status        String   @default("confirmed") // "pending", "confirmed", "cancelled"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tourId])
  @@index([bookingDate])
  @@index([status])
  @@map("bookings")
}
