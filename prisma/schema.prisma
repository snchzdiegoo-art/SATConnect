// SAT Connect - T.H.R.I.V.E. Engine Complete Schema
// 6 Entidades Relacionales + 38 Columnas Mapeadas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ============================================================================
// ENTIDAD 1: Tours (Core Data - 9 campos)
// ============================================================================
model Tour {
  id                        Int       @id @default(autoincrement())
  bokun_id                  Int?      @unique                  // Col A - Bókun ID / SKU
  product_name              String                              // Col B - Activity Name
  supplier                  String                              // Col C - Supplier
  location                  String                              // Col D - Location
  bokun_marketplace_status  String?                             // Col E - Bókun Marketplace Status
  bokun_status              String?                             // Col F - Bókun Status
  is_active                 Boolean   @default(true)            // Col G - Active Product
  is_audited                Boolean   @default(false)           // Col H - Audited
  last_update               DateTime  @default(now()) @updatedAt // Col T - Last Update

  // Relaciones 1:1 con entidades especializadas
  pricing                   TourPricing?
  logistics                 TourLogistics?
  assets                    TourAssets?
  distribution              TourDistribution?
  audit                     TourAudit?
  
  // Relación 1:N con historial de cambios
  change_logs               TourChangeLog[]
  
  // Relaciones 1:N con variantes y campos personalizados
  variants                  TourVariant[]
  custom_fields             TourCustomFieldValue[]

  createdAt                 DateTime  @default(now())

  @@map("tours")
  @@index([supplier])
  @@index([location])
  @@index([is_active])
}

// ============================================================================
// ENTIDAD 2: TourPricing (Revenue Optimization - 14 campos)
// ============================================================================
model TourPricing {
  id                        Int       @id @default(autoincrement())
  tour_id                   Int       @unique
  tour                      Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // SHARED RATES
  net_rate_adult            Decimal   @db.Decimal(10, 2)        // Col I - Shared Adult Net
  shared_factor             Decimal   @default(1.5) @db.Decimal(10, 5) // Col J - Shared Factor (1.5-1.99)
  // CALCULATED: suggested_pvp_adult = net_rate_adult * shared_factor (Col K)
  
  net_rate_child            Decimal?  @db.Decimal(10, 2)        // Col L - Shared Child Net
  // CALCULATED: suggested_pvp_child = net_rate_child * shared_factor (Col M)
  
  infant_age_threshold      Int?                                // Col N - Free Infant Age
  shared_min_pax            Int?                                // Col O - Shared Min Pax

  // PRIVATE RATES
  net_rate_private          Decimal?  @db.Decimal(10, 2)        // Col Q - Private Net
  private_factor            Decimal   @default(1.5) @db.Decimal(10, 5) // Col R - Private Factor
  private_min_pax           Int?                                // Col P - Private Min Pax
  private_min_pax_net_rate  Decimal?  @db.Decimal(10, 2)        // Private Min Pax Net Rate (base calculation)
  // CALCULATED: suggested_pvp_private = private_min_pax_net_rate * private_factor (Col S)
  // CALCULATED: per_pax_cost = private_min_pax_net_rate / private_min_pax (Col T)

  extra_fees                String?                             // Col AB - Extra Fees

  @@map("tour_pricing")
}

// ============================================================================
// ENTIDAD 3: TourLogistics (Operations - 5 campos)
// ============================================================================
model TourLogistics {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  duration              String?                                 // Col V - Duration
  days_of_operation     String?                                 // Col W - Days of Operation
  cxl_policy            String?                                 // Col X - CXL Policy
  meeting_point_info    String?   @db.Text                      // Col AA - Meeting Point / Pick Up
  pickup_info           String?   @db.Text                      // Pickup Information (complementary)

  @@map("tour_logistics")
}

// ============================================================================
// ENTIDAD 4: TourAssets (Content - 5 campos)
// ============================================================================
model TourAssets {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  pictures_url          String?                                 // Col U - Pictures Link
  landing_page_url      String?                                 // Col Y - Landing Page
  storytelling_url      String?                                 // Col Z - Storytelling Link
  notes                 String?   @db.Text                      // Col AL - Audit Notes
  capture_status        Boolean   @default(false)               // Capture Status (content captured)

  @@map("tour_assets")
}

// ============================================================================
// ENTIDAD 5: TourDistribution (OTA Markups - 15 campos)
// ============================================================================
model TourDistribution {
  id                            Int       @id @default(autoincrement())
  tour_id                       Int       @unique
  tour                          Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // MARKUPS
  website_markup                Decimal?  @db.Decimal(5, 2)     // Website Markup %
  marketplace_bokun_markup      Decimal?  @db.Decimal(5, 2)     // Marketplace Bókun Markup %
  marketplace_b2b_markup        Decimal?  @db.Decimal(5, 2)     // Marketplace B2B Markup %

  // OTA CHANNELS - Project Expedition
  project_expedition_id         String?                         // Col AC - Project Expedition ID
  project_expedition_status     String?                         // Col AD - Project Expedition Status
  project_expedition_commission Decimal?  @db.Decimal(5, 2)     // Project Expedition Commission %

  // OTA CHANNELS - Expedia
  expedia_id                    String?                         // Col AE - Expedia ID
  expedia_status                String?                         // Col AF - Expedia Status
  expedia_commission            Decimal?  @db.Decimal(5, 2)     // Expedia Commission %

  // OTA CHANNELS - Viator
  viator_id                     String?                         // Col AG - Viator ID
  viator_commission_percent     Decimal?  @db.Decimal(5, 2)     // Viator Commission %
  viator_status                 String?                         // Col AH - Viator Status

  // OTA CHANNELS - Klook
  klook_id                      String?                         // Col AI - Klook ID
  klook_status                  String?                         // Col AJ - Klook Status
  klook_commission              Decimal?  @db.Decimal(5, 2)     // Klook Commission %

  // OTA CHANNELS - Additional Channels
  tur_com_status                String?                         // Tur.com Status
  tur_com_commission            Decimal?  @db.Decimal(5, 2)     // Tur.com Commission %
  
  tourist_com_status            String?                         // Tourist.com Status
  tourist_com_commission        Decimal?  @db.Decimal(5, 2)     // Tourist.com Commission %
  
  headout_status                String?                         // Headout Status
  headout_commission            Decimal?  @db.Decimal(5, 2)     // Headout Commission %
  
  tourradar_status              String?                         // TourRadar Status
  tourradar_commission          Decimal?  @db.Decimal(5, 2)     // TourRadar Commission %

  @@map("tour_distribution")
}

// ============================================================================
// ENTIDAD 6: TourAudit (T.H.R.I.V.E. Logic - 3 campos)
// ============================================================================
model TourAudit {
  id                                Int       @id @default(autoincrement())
  tour_id                           Int       @unique
  tour                              Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // CALCULATED: HEALTHY | INCOMPLETE | AUDIT_REQUIRED
  product_health_score              String    @default("INCOMPLETE")
  
  // CALCULATED: 0-100 based on active OTA channels
  otas_distribution_score           Int       @default(0)
  
  // CALCULATED: Based on health + price parity
  is_suitable_for_global_distribution Boolean @default(false)

  @@map("tour_audit")
}

// ============================================================================
// ENTIDAD 7: TourChangeLog (Audit Trail - Change History)
// ============================================================================
model TourChangeLog {
  id          Int      @id @default(autoincrement())
  tour_id     Int
  tour        Tour     @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  
  // Change metadata
  change_type String   // "notes_added", "notes_edited", "tour_created", "pricing_updated", etc.
  field_name  String?  // e.g., "notes", "net_rate_adult"
  old_value   String?  @db.Text // Previous value (JSON for complex objects)
  new_value   String?  @db.Text // New value (JSON for complex objects)
  
  // User tracking (Clerk integration)
  user_id     String   // Clerk user ID
  user_name   String?  // User's display name
  user_email  String?  // User's email
  
  // Timestamps
  created_at  DateTime @default(now())
  
  @@index([tour_id])
  @@index([user_id])
  @@index([created_at])
  @@map("tour_change_logs")
}

// ============================================================================
// SUPPORTING MODELS (Existing - kept for compatibility)
// ============================================================================

model ChannelLog {
  id        String   @id @default(cuid())
  tourId    Int
  
  channel   String   // "expedia", "viator", "gyg", "civitatis"
  status    String   // "Active", "Inactive"
  
  updatedAt DateTime @updatedAt
  
  @@unique([tourId, channel])
  @@index([channel, status])
  @@map("channel_logs")
}

model Booking {
  id            String   @id @default(cuid())
  tourId        Int
  
  customerName  String
  customerEmail String?
  bookingDate   DateTime
  tourDate      DateTime
  
  adults        Int      @default(1)
  children      Int      @default(0)
  infants       Int      @default(0)
  
  totalPrice    Decimal  @db.Decimal(10, 2)
  status        String   @default("confirmed") // "pending", "confirmed", "cancelled"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tourId])
  @@index([bookingDate])
  @@index([status])
  @@map("bookings")
}
// ============================================================================
// ENTIDAD 7: Tour Variants (Pricing Options)
// ============================================================================
model TourVariant {
  id                Int       @id @default(autoincrement())
  tour_id           Int
  tour              Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  
  name              String    // e.g., "All Inclusive", "Ticket Only"
  description       String?   @db.Text
  
  // Pricing specific to this variant
  net_rate_adult    Decimal   @db.Decimal(10, 2)
  net_rate_child    Decimal?  @db.Decimal(10, 2)
  
  // Logistics overrides (optional)
  duration          String?
  
  is_active         Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("tour_variants")
}

// ============================================================================
// ENTIDAD 8: Custom Fields System
// ============================================================================
model CustomFieldDefinition {
  id          Int       @id @default(autoincrement())
  key         String    @unique // e.g., "difficulty_level"
  label       String    // e.g., "Difficulty Level"
  type        String    // "text", "number", "boolean", "select"
  options     String?   // JSON array for select options
  is_active   Boolean   @default(true)
  
  values      TourCustomFieldValue[]

  @@map("custom_field_definitions")
}

model GlobalOTASettings {
  id                Int      @id @default(autoincrement())
  channel_key       String   @unique // e.g. "viator", "expedia", "getyourguide", "klook"
  channel_name      String
  default_commission Decimal @default(0.00) @db.Decimal(5, 2)
  is_active         Boolean  @default(true)
  
  @@map("global_ota_settings")
}

model TourCustomFieldValue {
  id              Int                   @id @default(autoincrement())
  tour_id         Int
  tour            Tour                  @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  definition_id   Int
  definition      CustomFieldDefinition @relation(fields: [definition_id], references: [id])
  
  value           String                @db.Text // Stored as string, parsed based on definition.type

  @@unique([tour_id, definition_id])
  @@map("tour_custom_field_values")
}
