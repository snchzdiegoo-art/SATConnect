// SAT Connect - T.H.R.I.V.E. Engine Complete Schema
// Phase 1 & 2: Supplier + DistributionChannel master entities + structural Tour split
// Phase H: Strategy Integration (NotebookLM)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ============================================================================
// ENUMS & STRATEGIC TYPES
// ============================================================================

enum SupplierTier {
  STANDARD
  PRO
  ELITE
}

enum PricingMode {
  TOP_DOWN   // Calculated from PVP
  BOTTOM_UP  // Calculated from Net Cost
}

// ============================================================================
// ENTIDAD 1: Tours (Core Data - 9 campos)
// ============================================================================
model Tour {
  id                        Int       @id @default(autoincrement())
  bokun_id                  Int?      @unique                  // Col A - BÃ³kun ID / SKU
  product_name              String                              // Col B - Activity Name

  // IDENTITY â€” Legacy string (kept for backward compat) + new FK
  supplier                  String                              // Col C - legacy string
  supplier_id               Int?                                // Phase 1: FK -> Supplier
  supplier_rel              Supplier?  @relation(fields: [supplier_id], references: [id])

  // LOCATION â€” Legacy single field + Phase 2 split
  location                  String                              // Col D - legacy full location
  location_state            String?                             // Phase 2: e.g. "Quintana Roo"
  location_city             String?                             // Phase 2: e.g. "CancÃºn"

  bokun_marketplace_status  String?                             // Col E - BÃ³kun Marketplace Status
  bokun_status              String?                             // Col F - BÃ³kun Status
  is_active                 Boolean   @default(true)            // Col G - Active Product
  is_audited                Boolean   @default(false)           // Col H - Audited
  last_update               DateTime  @default(now()) @updatedAt // Col T - Last Update

  // Relaciones 1:1 con entidades especializadas
  pricing                   TourPricing?
  logistics                 TourLogistics?
  assets                    TourAssets?
  distribution              TourDistribution?
  audit                     TourAudit?

  // Phase 1: M2M links to DistributionChannel
  channel_links             TourChannelLink[]

  // RelaciÃ³n 1:N con historial de cambios
  change_logs               TourChangeLog[]

  // Relaciones 1:N con variantes y campos personalizados
  variants                  TourVariant[]
  custom_fields             TourCustomFieldValue[]

  createdAt                 DateTime  @default(now())

  @@map("tours")
  @@index([supplier])
  @@index([supplier_id])
  @@index([location])
  @@index([location_state])
  @@index([location_city])
  @@index([is_active])
}

// ============================================================================
// ENTIDAD 2: TourPricing (Revenue Optimization - 14 campos)
// ============================================================================
model TourPricing {
  id                        Int       @id @default(autoincrement())
  tour_id                   Int       @unique
  tour                      Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // SHARED RATES
  net_rate_adult            Decimal   @db.Decimal(10, 2)        // Col I - Shared Adult Net
  shared_factor             Decimal   @default(1.5) @db.Decimal(10, 5) // Col J - Shared Factor (1.5-1.99)
  // CALCULATED: suggested_pvp_adult = net_rate_adult * shared_factor (Col K)

  net_rate_child            Decimal?  @db.Decimal(10, 2)        // Col L - Shared Child Net
  // CALCULATED: suggested_pvp_child = net_rate_child * shared_factor (Col M)

  infant_age_threshold      Int?                                // Col N - Free Infant Age
  shared_min_pax            Int?                                // Col O - Shared Min Pax

  // PRIVATE RATES
  net_rate_private          Decimal?  @db.Decimal(10, 2)        // Col Q - Private Net
  private_factor            Decimal   @default(1.5) @db.Decimal(10, 5) // Col R - Private Factor
  private_min_pax           Int?                                // Col P - Private Min Pax
  private_min_pax_net_rate  Decimal?  @db.Decimal(10, 2)        // Private Min Pax Net Rate (base calculation)
  // CALCULATED: suggested_pvp_private = private_min_pax_net_rate * private_factor (Col S)
  // CALCULATED: per_pax_cost = private_min_pax_net_rate / private_min_pax (Col T)

  extra_fees                String?                             // Col AB - Extra Fees

  // Phase 2 additions
  public_rate               Decimal?  @db.Decimal(10, 2)        // Explicit PVP override (Case A input)
  currency                  String    @default("MXN")            // MXN | USD
  operational_costs         Decimal?  @db.Decimal(10, 2)        // Fixed ops cost for margin calc
  seasonal_rates            Json?                               // [{ from, to, net_rate_adult, net_rate_child }]
  
  // Phase H: Strategy Integration
  pricing_mode              PricingMode @default(BOTTOM_UP)
  manual_margin_factor      Decimal   @default(1.5) @db.Decimal(10, 5) // For Bottom-Up calculations

  @@map("tour_pricing")
}

// ============================================================================
// ENTIDAD 3: TourLogistics (Operations - 5 campos)
// ============================================================================
model TourLogistics {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  duration              String?                                 // Col V - Duration
  days_of_operation     String?                                 // Col W - Days of Operation
  cxl_policy            String?                                 // Col X - CXL Policy
  meeting_point_info    String?   @db.Text                      // Col AA - Meeting Point / Pick Up
  pickup_info           String?   @db.Text                      // Pickup Information (complementary)

  // Phase 2 additions
  operation_hours       String?                                 // e.g. "08:00â€“17:00"
  blackout_dates        DateTime[]                              // Dates the tour does NOT operate
  meeting_points        Json?                                   // [{ name, address, lat?, lng? }]

  @@map("tour_logistics")
}

// ============================================================================
// ENTIDAD 4: TourAssets (Content - 5 campos)
// ============================================================================
model TourAssets {
  id                    Int       @id @default(autoincrement())
  tour_id               Int       @unique
  tour                  Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  pictures_url          String?                                 // Col U - legacy single URL (kept)
  pictures              String[]                                // Phase 2: array of image URLs
  landing_page_url      String?                                 // Col Y - Landing Page
  storytelling_url      String?                                 // Col Z - Storytelling Link
  storytelling_content  String?   @db.Text                      // Phase 2: rich B2B storytelling text
  notes                 String?   @db.Text                      // Col AL - Audit Notes
  capture_status        Boolean   @default(false)               // Capture Status (content captured)

  @@map("tour_assets")
}

// ============================================================================
// ENTIDAD 5: TourDistribution (OTA Markups - 15 campos)
// ============================================================================
model TourDistribution {
  id                            Int       @id @default(autoincrement())
  tour_id                       Int       @unique
  tour                          Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // MARKUPS
  website_markup                Decimal?  @db.Decimal(5, 2)     // Website Markup %
  marketplace_bokun_markup      Decimal?  @db.Decimal(5, 2)     // Marketplace BÃ³kun Markup %
  marketplace_b2b_markup        Decimal?  @db.Decimal(5, 2)     // Marketplace B2B Markup %

  // OTA CHANNELS - Project Expedition
  project_expedition_id         String?                         // Col AC - Project Expedition ID
  project_expedition_status     String?                         // Col AD - Project Expedition Status
  project_expedition_commission Decimal?  @db.Decimal(5, 2)     // Project Expedition Commission %

  // OTA CHANNELS - Expedia
  expedia_id                    String?                         // Col AE - Expedia ID
  expedia_status                String?                         // Col AF - Expedia Status
  expedia_commission            Decimal?  @db.Decimal(5, 2)     // Expedia Commission %

  // OTA CHANNELS - Viator
  viator_id                     String?                         // Col AG - Viator ID
  viator_commission_percent     Decimal?  @db.Decimal(5, 2)     // Viator Commission %
  viator_status                 String?                         // Col AH - Viator Status

  // OTA CHANNELS - Klook
  klook_id                      String?                         // Col AI - Klook ID
  klook_status                  String?                         // Col AJ - Klook Status
  klook_commission              Decimal?  @db.Decimal(5, 2)     // Klook Commission %

  // OTA CHANNELS - Additional Channels
  tur_com_status                String?                         // Tur.com Status
  tur_com_commission            Decimal?  @db.Decimal(5, 2)     // Tur.com Commission %
  
  tourist_com_status            String?                         // Tourist.com Status
  tourist_com_commission        Decimal?  @db.Decimal(5, 2)     // Tourist.com Commission %
  
  headout_status                String?                         // Headout Status
  headout_commission            Decimal?  @db.Decimal(5, 2)     // Headout Commission %
  
  tourradar_status              String?                         // TourRadar Status
  tourradar_commission          Decimal?  @db.Decimal(5, 2)     // TourRadar Commission %

  @@map("tour_distribution")
}

// ============================================================================
// ENTIDAD 6: TourAudit (T.H.R.I.V.E. Logic - 3 campos)
// ============================================================================
model TourAudit {
  id                                Int       @id @default(autoincrement())
  tour_id                           Int       @unique
  tour                              Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)

  // CALCULATED fields
  product_health_score              String    @default("INCOMPLETE") 
  quality_score                     Int       @default(0)             // 0-100 numeric score
  
  // GATEKEEPER FIELDS
  risk_policy_status                String    @default("MISSING")     // "MISSING" | "VALID" | "EXPIRED"
  profit_shield_status              Boolean   @default(false)         // True if PVP > Net + Margin
  
  // CALCULATED: 0-100 based on active OTA channels
  otas_distribution_score           Int       @default(0)
  
  // CALCULATED: Based on health + price parity
  is_suitable_for_global_distribution Boolean @default(false)

  @@map("tour_audit")
}

// ============================================================================
// ENTIDAD 7: TourChangeLog (Audit Trail - Change History)
// ============================================================================
model TourChangeLog {
  id          Int      @id @default(autoincrement())
  tour_id     Int
  tour        Tour     @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  
  // Change metadata
  change_type String   // "notes_added", "notes_edited", "tour_created", "pricing_updated", etc.
  field_name  String?  // e.g., "notes", "net_rate_adult"
  old_value   String?  @db.Text // Previous value (JSON for complex objects)
  new_value   String?  @db.Text // New value (JSON for complex objects)
  
  // User tracking (Clerk integration)
  user_id     String   // Clerk user ID
  user        User     @relation(fields: [user_id], references: [id])
  user_name   String?  // User's display name
  user_email  String?  // User's email
  
  // Timestamps
  created_at  DateTime @default(now())
  
  @@index([tour_id])
  @@index([user_id])
  @@index([created_at])
  @@map("tour_change_logs")
}

// ============================================================================
// SUPPORTING MODELS (Existing - kept for compatibility)
// ============================================================================

// ============================================================================
// PHASE 1: MASTER ENTITY â€” Supplier
// ============================================================================
model Supplier {
  id             Int          @id @default(autoincrement())
  name           String       @unique
  contact_info   Json?        // { email?: string, phone?: string }
  badges         String[]     // e.g. ["Top Seller", "Verified"]
  is_active      Boolean      @default(true)
  profile_status String       @default("Complete") // "Complete" | "Incomplete Profile"
  
  // Phase H: Strategy Integration
  tier           SupplierTier @default(STANDARD)
  founded_at     DateTime?    // For "Aliados Fundadores" program tracking

  tours          Tour[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  @@map("suppliers")
}

// ============================================================================
// PHASE 1: MASTER ENTITY â€” DistributionChannel
// ============================================================================
model DistributionChannel {
  id                      Int               @id @default(autoincrement())
  name                    String            @unique // e.g. "Viator", "Expedia"
  base_commission_percent Decimal           @default(0.00) @db.Decimal(5, 2)
  is_active               Boolean           @default(true)
  channel_links           TourChannelLink[]
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  @@map("distribution_channels")
}

// ============================================================================
// PHASE 1: PIVOT TABLE â€” Tour <-> DistributionChannel (M2M)
// ============================================================================
model TourChannelLink {
  id                          Int                 @id @default(autoincrement())
  tour_id                     Int
  tour                        Tour                @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  channel_id                  Int
  channel                     DistributionChannel @relation(fields: [channel_id], references: [id])
  external_id                 String?             // Product ID on this OTA (e.g. Viator code)
  channel_commission_override Decimal?            @db.Decimal(5, 2) // Override base commission
  show_in_b2b_marketplace     Boolean             @default(false)
  status                      String?             // "Active" | "Inactive" | "Pending"
  @@unique([tour_id, channel_id])
  @@index([tour_id])
  @@index([channel_id])
  @@map("tour_channel_links")
}

model ChannelLog {
  id        String   @id @default(cuid())
  tourId    Int

  channel   String   // "expedia", "viator", "gyg", "civitatis"
  status    String   // "Active", "Inactive"

  updatedAt DateTime @updatedAt

  @@unique([tourId, channel])
  @@index([channel, status])
  @@map("channel_logs")
}

model Booking {
  id            String   @id @default(cuid())
  tourId        Int
  
  customerName  String
  customerEmail String?
  bookingDate   DateTime
  tourDate      DateTime
  
  adults        Int      @default(1)
  children      Int      @default(0)
  infants       Int      @default(0)
  
  totalPrice    Decimal  @db.Decimal(10, 2)
  status        String   @default("confirmed") // "pending", "confirmed", "cancelled"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tourId])
  @@index([bookingDate])
  @@index([status])
  @@map("bookings")
}

// ============================================================================
// ENTIDAD 7: Tour Variants (Pricing Options)
// ============================================================================
model TourVariant {
  id                Int       @id @default(autoincrement())
  tour_id           Int
  tour              Tour      @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  
  name              String    // e.g., "All Inclusive", "Ticket Only"
  description       String?   @db.Text
  
  // Pricing specific to this variant
  net_rate_adult    Decimal   @db.Decimal(10, 2)
  net_rate_child    Decimal?  @db.Decimal(10, 2)
  
  // Logistics overrides (optional)
  duration          String?
  
  is_active         Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("tour_variants")
}

// ============================================================================
// ENTIDAD 8: Custom Fields System
// ============================================================================
model CustomFieldDefinition {
  id          Int       @id @default(autoincrement())
  key         String    @unique // e.g., "difficulty_level"
  label       String    // e.g., "Difficulty Level"
  type        String    // "text", "number", "boolean", "select"
  options     String?   // JSON array for select options
  is_active   Boolean   @default(true)
  
  values      TourCustomFieldValue[]

  @@map("custom_field_definitions")
}

model GlobalOTASettings {
  id                Int      @id @default(autoincrement())
  channel_key       String   @unique // e.g. "viator", "expedia", "getyourguide", "klook"
  channel_name      String
  default_commission Decimal @default(0.00) @db.Decimal(5, 2)
  is_active         Boolean  @default(true)
  
  @@map("global_ota_settings")
}

model TourCustomFieldValue {
  id              Int                   @id @default(autoincrement())
  tour_id         Int
  tour            Tour                  @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  definition_id   Int
  definition      CustomFieldDefinition @relation(fields: [definition_id], references: [id])
  
  value           String                @db.Text // Stored as string, parsed based on definition.type

  @@unique([tour_id, definition_id])
  @@map("tour_custom_field_values")
}

// ============================================================================
// PHASE 1: IDENTITY & RBAC
// ============================================================================
model User {
  id              String    @id // Clerk User ID
  email           String    @unique
  first_name      String?
  last_name       String?
  image_url       String?
  
  // Role Management
  role            String    @default("viewer") // "super_admin", "admin", "editor", "viewer"
  status          String    @default("pending") // "active", "pending", "disabled"
  
  // Relations
  change_logs     TourChangeLog[]
  tasks           Task[]          @relation("TaskAssignee")
  projects        Project[]       @relation("ProjectOwner")
  docs            Doc[]           @relation("DocAuthor")
  objectives      Objective[]     @relation("ObjectiveOwner")
  
  // Metadata
  last_sign_in_at DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@map("users")
}

// ============================================================================
// PHASE 2: WORKSPACE
// ============================================================================

model Project {
  id          Int       @id @default(autoincrement())
  title       String
  description String?   @db.Text
  color       String    @default("#29FFC6") // hex color for card header
  icon        String    @default("folder")  // lucide icon name
  status      String    @default("active")  // "active", "completed", "archived"
  due_date    DateTime?

  owner_id    String
  owner       User      @relation("ProjectOwner", fields: [owner_id], references: [id])

  tasks       Task[]
  docs        Doc[]

  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@map("projects")
}

model Task {
  id           Int       @id @default(autoincrement())
  title        String
  notes        String?   @db.Text
  status       String    @default("inbox")  // "inbox", "today", "upcoming", "done"
  priority     String    @default("none")   // "none", "low", "medium", "high"
  due_date     DateTime?
  completed_at DateTime?

  project_id   Int?
  project      Project?  @relation(fields: [project_id], references: [id], onDelete: SetNull)

  parent_id    Int?
  parent       Task?     @relation("Subtasks", fields: [parent_id], references: [id], onDelete: Cascade)
  subtasks     Task[]    @relation("Subtasks")

  assignee_id  String?
  assignee     User?     @relation("TaskAssignee", fields: [assignee_id], references: [id], onDelete: SetNull)

  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  @@map("tasks")
}

model Objective {
  id          Int         @id @default(autoincrement())
  title       String
  description String?     @db.Text
  quarter     Int         // 1-4
  year        Int
  status      String      @default("on_track") // "on_track", "at_risk", "done"

  owner_id    String
  owner       User        @relation("ObjectiveOwner", fields: [owner_id], references: [id])

  key_results KeyResult[]

  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  @@map("objectives")
}

model KeyResult {
  id            Int       @id @default(autoincrement())
  title         String
  target_value  Float
  current_value Float     @default(0)
  unit          String    @default("%") // "%", "$", "count", etc.

  objective_id  Int
  objective     Objective @relation(fields: [objective_id], references: [id], onDelete: Cascade)

  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@map("key_results")
}

model Doc {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @default("") @db.Text // markdown
  emoji       String   @default("ðŸ“„")

  project_id  Int?
  project     Project? @relation(fields: [project_id], references: [id], onDelete: SetNull)

  author_id   String
  author      User     @relation("DocAuthor", fields: [author_id], references: [id])

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("docs")
}
